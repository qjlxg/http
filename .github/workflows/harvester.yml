name: harvester

on:
  # 1. å½“è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'one_step_harvester.py'
      - '.github/workflows/harvester.yml'
  
  # 2. æ”¯æŒåœ¨ Actions é¡µé¢ç‚¹å‡»æŒ‰é’®æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  
  # 3. å®šæ—¶è‡ªåŠ¨è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:00 å’Œ 20:00ï¼‰
  schedule:
    - cron: '0 0,12 * * *'

jobs:
  one-step-run:
    runs-on: ubuntu-latest
    # å¿…é¡»èµ‹äºˆå†™æƒé™ï¼Œå¦åˆ™æ— æ³•æäº¤ç»“æœå›ä»“åº“
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: å®‰è£…å¿…è¦ä¾èµ–
        run: pip install requests

      - name: åˆ‡æ¢ä¸Šæµ·æ—¶åŒº
        run: sudo timedatectl set-timezone Asia/Shanghai

      - name: æ‰§è¡Œå…¨è‡ªåŠ¨æ”¶å‰²è„šæœ¬
        env:
          # ç¡®ä¿ä½ åœ¨ä»“åº“çš„ Secrets é‡Œé…ç½®äº† MY_GITHUB_TOKEN
          MY_GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: python one_step_harvester.py

      - name: è‡ªåŠ¨æäº¤æ¸…æ´—åçš„ç»“æœ
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Combined-Harvester-Bot"
          
          # å°†äº§å‡ºçš„ nodes.txt å’Œç»Ÿè®¡è¡¨åŠ å…¥æš‚å­˜åŒº
          git add results/nodes.txt results/statistics.csv
          
          # åªæœ‰åœ¨æ–‡ä»¶ç¡®å®æœ‰å˜åŒ–æ—¶æ‰æäº¤ï¼Œé˜²æ­¢äº§ç”Ÿæ— æ„ä¹‰çš„ Commit
          if ! git diff --cached --quiet; then
            git commit -m "ğŸš€ è„šæœ¬/é…ç½®è§¦å‘æ›´æ–°: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          else
            echo "ç»“æœæœªå‘ç”Ÿå˜åŒ–ï¼Œæ— éœ€æ¨é€ã€‚"
          fi
